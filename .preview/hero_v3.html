<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Preview – hero_v3</title>

  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  

  <style>

body{ font-family: Montserrat, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }

.overlay-toolbar{
  position: relative;
  top: 0;
  z-index: 60;
  backdrop-filter: blur(8px);
  background: rgba(255,255,255,.86);
  border-bottom: 1px solid rgba(0,0,0,.08);
}

/* --- Viewport toolbar --- */
.vpbar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.vpbtn{
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.12);
  background: #fff;
  cursor: pointer;
  user-select:none;
}
.vpbtn[data-active="1"]{
  background:#0f172a;
  color:#fff;
  border-color: rgba(15,23,42,.3);
}
.vpmeta{ font-size: 12px; color: rgba(15,23,42,.75); white-space: nowrap; }
.vptrack{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.vprail{
  position:relative;
  height: 10px;
  width: 220px;
  border-radius: 999px;
  background: rgba(15,23,42,.10);
  border: 1px solid rgba(0,0,0,.08);
  cursor: ew-resize;
  user-select:none;
}
.vpthumb{
  position:absolute;
  top: 50%;
  transform: translate(-50%,-50%);
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background:#0f172a;
  box-shadow: 0 8px 20px rgba(0,0,0,.16);
}
.vprail:active .vpthumb{ transform: translate(-50%,-50%) scale(1.05); }

/* --- Non-scaling device frame wrapper --- */
.preview-stage{
  width: 100%;
  display:flex;
  justify-content:center;
  padding: 16px 12px 40px;
}

.device-frame{
  transform: none !important;
  zoom: 1 !important;

  width: var(--vpw, 1728px);
  max-width: min(100%, var(--design-w, 1728px));
  background: #fff;
  position: relative;
}

.device-frame-inner{ width: 100%; }

.device-outline{
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 14px 38px rgba(0,0,0,.10);
  overflow: hidden;
}

#cmp_root{
  position: relative;
  width: 100%;
  height: var(--cmp-h, auto);

  max-width: min(var(--vpw, 1728px), var(--design-w, 1728px));
  margin-left: auto;
  margin-right: auto;

  overflow: hidden;

  /* default overlay clamp = desktop design width */
  --overlay-w: var(--design-w, 1728px);
}

.bg-layer{
  position:absolute;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}
.bg-layer img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:block;
  object-fit: var(--bg-fit, cover);
  object-position: var(--bg-pos, center);
}

.content-layer{
  position:relative;
  z-index:10;
  width:100%;
}

/* replace ONLY the .overlay-img block in preview.styles.js with this */

.overlay-img{
  position: absolute;
  top: 0;

  /* Center the overlay when it's narrower than the viewport */
  left: 50%;
  transform: translateX(-50%);

  /* Fill available width, but never exceed the active overlay design width */
  width: 100%;
  height: auto;

  max-width: min(
    var(--vpw, 1728px),
    var(--overlay-w, var(--design-w, 1728px))
  );

  pointer-events: none;

  /* Defaults (JS also sets inline styles for reliability) */
  opacity: var(--oop, 0.5);
  mix-blend-mode: var(--obm, normal);

  z-index: 40;
}


.overlay-hidden{ display: none; }

/* --- Score modal --- */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  backdrop-filter: blur(4px);
  display:none;
  z-index: 1000;
  align-items:center;
  justify-content:center;
  padding: 24px;
}
.modal-backdrop[data-open="1"]{ display:flex; }

.modal{
  width: min(920px, 100%);
  background:#fff;
  border-radius:16px;
  box-shadow: 0 20px 60px rgba(0,0,0,.22);
  border: 1px solid rgba(0,0,0,.08);
  overflow:hidden;
}
.modal-hd{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  padding: 16px 18px;
  border-bottom: 1px solid rgba(0,0,0,.08);
  background: rgba(248,250,252,.9);
}
.modal-title{ font-size: 14px; font-weight: 700; color:#0f172a; }
.modal-sub{ font-size: 12px; color: rgba(15,23,42,.7); margin-top: 2px; }
.modal-bd{ padding: 16px 18px; }
.pill{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.12);
  background: #fff;
  color:#0f172a;
  font-weight: 600;
}
.pill[data-kind="pass"]{ border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.10); }
.pill[data-kind="fail"]{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

.grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px){ .grid{ grid-template-columns: 1fr; } }
.card{
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 14px;
  padding: 12px 12px;
  background: #fff;
}
.k{ font-size: 11px; color: rgba(15,23,42,.65); text-transform: uppercase; letter-spacing: .06em; }
.v{ margin-top: 4px; font-size: 13px; color:#0f172a; font-weight: 600; }
.mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }

.modal-ft{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 14px 18px;
  border-top: 1px solid rgba(0,0,0,.08);
  background: rgba(248,250,252,.9);
  flex-wrap: wrap;
}
.btn2{
  font-size: 12px;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,.12);
  background: #fff;
  cursor:pointer;
}
.btn2:hover{ background: rgba(241,245,249,.8); }
.btn2.primary{
  background: #0f172a;
  color:#fff;
  border-color: rgba(15,23,42,.3);
}
.btn2.primary:hover{ background:#111c33; }

.links a{
  font-size: 12px;
  color:#0f172a;
  text-decoration: underline;
  text-underline-offset: 2px;
  opacity:.9;
  margin-right: 10px;
  white-space: nowrap;
}

  </style>
</head>

<body class="antialiased bg-white">
  <div class="overlay-toolbar" id="toolbar_root">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <div class="vpbar">
        <span class="vpmeta">Viewport:</span>
        <button id="vp_mobile" class="vpbtn" type="button" data-active="0">Mobile</button>
        <button id="vp_tablet" class="vpbtn" type="button" data-active="0">Tablet</button>
        <button id="vp_desktop" class="vpbtn" type="button" data-active="1">Desktop</button>

        <div class="vptrack">
          <span class="vpmeta">Width</span>
          <div id="vp_rail" class="vprail" role="slider" aria-label="Preview width">
            <div id="vp_thumb" class="vpthumb"></div>
          </div>
          <span id="vp_readout" class="vpmeta mono">—</span>
        </div>
      </div>

      
      <div class="flex items-center gap-2 ml-auto" id="ov_controls">
        <input id="ov_enabled" type="checkbox" checked />
        <label for="ov_enabled" class="text-sm font-medium">Figma overlay</label>
      </div>

      <div class="flex items-center gap-2" id="ov_opacity_wrap">
        <label class="text-sm text-slate-700">Opacity</label>
        <input id="ov_opacity" type="range" min="0" max="100" value="50" />
        <span id="ov_opacity_val" class="text-sm text-slate-700 w-12">50%</span>
      </div>

      <div class="flex items-center gap-2" id="ov_diff_wrap">
        <input id="ov_diff" type="checkbox" />
        <label for="ov_diff" class="text-sm text-slate-700">Difference</label>
      </div>

      <button id="ov_reset" class="text-sm px-3 py-1 border rounded-md bg-white hover:bg-slate-50">
        Reset
      </button>

      <button id="ov_scores" class="text-sm px-3 py-1 border rounded-md bg-white hover:bg-slate-50">
        Scores
      </button>
      
    </div>
  </div>

  <div class="preview-stage">
    <div id="device_frame" class="device-frame device-outline" style="--vpw:1728px; --design-w:1728px;">
      <div class="device-frame-inner">
        <section class="relative">
          <div id="ov_root" class="relative flex flex-col items-center w-full mx-auto ">
            <div id="cmp_root" style="height:auto; --oop:0.5; --obm:normal;">
              <div class="content-layer">
                <section class="relative flex overflow-hidden" style="background-image: linear-gradient(0deg, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%), url('/assets/fill_a94929a5bfc7f77233fd62ea-mkcqq3ey.png'); background-size: cover; background-position: center; background-repeat: no-repeat;" role="banner" aria-labelledby="3163_2414-heading">
<div class="w-full max-w-[108rem]">
<div data-node-id="3163:2414" data-node="3163:2414" class="flex flex-col md:flex-row md:justify-end md:items-center gap-[0.5rem] pt-[5rem] pr-[5rem] pb-[5rem] pl-[5rem] overflow-hidden"><div data-node-id="3163:2415" data-node="3163:2415" class="flex flex-col md:flex-col md:justify-start md:items-start gap-[0.5rem] pt-[0.5rem] pr-[0.5rem] pb-[0.5rem] pl-[0.5rem] border-[0.3125rem] border-[rgba(9,2,164,1)] w-[39.1875rem] max-w-full shrink-0 self-start"><div data-node-id="3163:2416" data-node="3163:2416" class="flex flex-col md:flex-col md:justify-start md:items-start gap-[3.5rem] pt-[4rem] pr-[4rem] pb-[4rem] pl-[4rem] border-[0.1875rem] border-[rgba(9,2,164,1)] self-start"><div data-node-id="3163:2417" data-node="3163:2417" class="flex flex-col md:flex-col md:justify-start md:items-start gap-[1rem] self-start"><div data-node-id="3163:2418" data-node="3163:2418" class="flex flex-col md:flex-col md:justify-start md:items-start gap-[0.5rem] self-start"><p data-node-id="3163:2419" data-node="3163:2419" data-ff="Montserrat" class="text-left text-[1.125rem] font-[500] tracking-[0.0625rem] text-[#000000] font-['Montserrat'] uppercase">WHITNEY MOORE</p>
<h1 data-node-id="3163:2420" data-node="3163:2420" data-ff="Montserrat" class="text-left text-[4.25rem] font-[700] leading-[4.875rem] tracking-[0.0625rem] text-[#0902a4] font-['Montserrat']" id="3163_2414-heading">Experience. Clarity. Results.</h1></div>
<h3 data-node-id="3163:2421" data-node="3163:2421" data-ff="Montserrat" class="text-left text-[1.5rem] font-[500] tracking-[0.0625rem] text-[#000000] font-['Montserrat']">Driven by values since 1882.</h3></div>
<div data-node-id="3163:2422" data-node="3163:2422" class="flex flex-col md:flex-row md:justify-start md:items-start gap-[0.75rem] self-start"><button data-node-id="3163:2423" data-node="3163:2423" type="button" aria-label="View Practice Areas" class="flex flex-col md:flex-row md:justify-center md:items-center gap-[0.5rem] pt-[1rem] pr-[2rem] pb-[1rem] pl-[2rem] bg-[rgba(9,2,164,1)] bg-center shadow-[0.625rem_0.875rem_1.5rem_rgba(0,0,0,0.25)] btn inline-flex justify-center items-center gap-2 whitespace-nowrap hover:opacity-90 transition-opacity duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 px-8 py-5 min-h-14 lg:w-[17.9375rem] lg:h-[3.5rem] lg:min-h-0 w-[17.9375rem] max-w-full shrink-0 self-center"><span class="font-['Montserrat'] text-[1.25rem] leading-[1.25rem] tracking-[0.0625rem] font-[400] text-[rgba(255,255,255,1)]">View Practice Areas</span></button>
<button data-node-id="3163:2424" data-node="3163:2424" type="button" aria-label="About Us" class="flex flex-col md:flex-row md:justify-center md:items-center gap-[0.5rem] pt-[1rem] pr-[2rem] pb-[1rem] pl-[2rem] bg-[rgba(219,234,254,1)] bg-center shadow-[1.25rem_0.875rem_1.5rem_rgba(0,0,0,0.07999999821186066)] btn inline-flex justify-center items-center gap-2 whitespace-nowrap hover:opacity-90 transition-opacity duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 px-8 py-5 min-h-14 lg:w-[9.8125rem] lg:h-[3.5rem] lg:min-h-0 w-[9.8125rem] max-w-full shrink-0 self-center"><span class="font-['Montserrat'] text-[1.25rem] leading-[1.25rem] font-[400] text-[rgba(29,78,216,1)]">About Us</span></button></div></div></div></div>
</div>
</section>
              </div>

              <img
                        id="ov_img"
                        data-figma-overlay="1"
                        class="overlay-img"
                        src="/assets/home_v3_desktop-mkcv96rc.png"
                        data-ov-w="1728"
                        data-ov-h="878"
                        data-group-ov-mobile="/assets/home_v3_desktop-mkcv96rc.png"
                        data-group-ov-desktop="/assets/home_v3_desktop-mkcv96rc.png"
                        alt=""
                        aria-hidden="true"
                      />
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- =========================================================
       (SAFE) Responsive injection + one-screen variant swapping
       ========================================================= -->
  <script>
    (function(){
      const initialSlug = "hero_v3";
      const groupKey = "hero_v3"; // MUST be slug-safe (e.g. "home_v3")
      const frameName = "Home v3@desktop";
      const respWidths = {"mobile":390,"tablet":1084,"desktop":1728};
      const overlayW = {"mobile":390,"tablet":1084,"desktop":1728};
      const isMergedGroup = false;

      // Current active slug used by patches/scores/compare
      // In merged-group mode, we keep this as the group key (so compare/patches are group-scoped).
      window.__CURRENT_PREVIEW_SLUG__ = isMergedGroup ? groupKey : initialSlug;

      window.__RESPONSIVE__ = {
        groupKey,
        widths: respWidths,
        breakpoints: { mobileMax: 768, tabletMax: 1084 },
        overlayW,
        frameName,
        initialSlug,
        mergedGroup: isMergedGroup
      };

      const contentEl = document.querySelector("#cmp_root .content-layer");
      const ovImg = document.getElementById("ov_img");

      const initialContentHtml = contentEl ? contentEl.innerHTML : "";
      const initialOverlaySrc = ovImg ? (ovImg.getAttribute("src") || "") : "";
      const initialOvW = ovImg ? Number(ovImg.getAttribute("data-ov-w") || 0) : 0;
      if (initialOvW && isFinite(initialOvW)) window.__RESPONSIVE__.overlayW.desktop = initialOvW;

      function applyOverlayClamp(bucket){
        if (!ovImg) return;

        const attrW = Number(ovImg.getAttribute("data-ov-w") || 0);
        const ow =
          (attrW && isFinite(attrW) && attrW > 0)
            ? attrW
            : (Number(window.__RESPONSIVE__?.overlayW?.[bucket]) || 0);

        if (ow && isFinite(ow) && ow > 0) ovImg.style.maxWidth = ow + "px";
        else ovImg.style.maxWidth = "";
      }

      function uniq(arr){
        return Array.from(new Set((arr || []).map(s => String(s||"").trim()).filter(Boolean)));
      }

      function toSlug(s){
        return String(s || "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "_")
          .replace(/[^a-z0-9_@\-]+/g, "")
          .replace(/_+/g, "_")
          .replace(/^_+|_+$/g, "");
      }

      function deriveCandidateSlugs(bucket){
        const b = String(bucket || "").trim().toLowerCase();
        const out = [];

        if (groupKey) out.push(groupKey + "_" + b);

        const baseFromInitial = String(initialSlug || "").replace(/(_|-|@)(desktop|tablet|mobile)$/i, "");
        if (baseFromInitial) out.push(baseFromInitial + "_" + b);

        if (groupKey) out.push(groupKey + "-" + b);
        if (groupKey) out.push(groupKey + "@" + b);

        if (initialSlug) {
          out.push(initialSlug.replace(/(_|-|@)(desktop|tablet|mobile)$/i, "$1" + b));
          out.push(initialSlug.replace(/(desktop|tablet|mobile)$/i, b));
          out.push(initialSlug + "_" + b);
        }

        if (frameName) {
          const base = frameName.includes("@") ? frameName.split("@")[0].trim() : frameName.trim();
          if (base) {
            out.push(toSlug(base + "_" + b));
            out.push(toSlug(base + "-" + b));
            out.push(toSlug(base + "@" + b));
          }
        }

        return uniq(out);
      }

      async function fetchVariantHtml(variantSlug){
        const url = "/preview/" + encodeURIComponent(variantSlug) + "?embed=1&toolbar=0";
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("Variant not found: " + variantSlug);
        return await r.text();
      }

      function extractFromHtml(html){
        const doc = new DOMParser().parseFromString(String(html||""), "text/html");
        const c = doc.querySelector("#cmp_root .content-layer");
        const o = doc.getElementById("ov_img");
        const ow = o ? Number(o.getAttribute("data-ov-w") || 0) : 0;
        const oh = o ? Number(o.getAttribute("data-ov-h") || 0) : 0;
        const overlaySrc = o ? (o.getAttribute("src") || "") : "";
        return {
          contentHtml: c ? c.innerHTML : "",
          overlaySrc,
          overlayW: (ow && isFinite(ow) && ow > 0) ? ow : 0,
          overlayH: (oh && isFinite(oh) && oh > 0) ? oh : 0,
        };
      }

      async function reapplyPatchesIfAvailable(){
        if (typeof window.__applyPatchesForCurrentSlug__ === "function") {
          try { await window.__applyPatchesForCurrentSlug__(); } catch {}
        }
      }

      // --- overlay-by-breakpoint switching ---
      let _ovSwapNonce = 0;

      function preferredGroupOverlaySrc(bucket){
        const b = String(bucket || "").toLowerCase();
        if (!ovImg) return "";
        const m = ovImg.getAttribute("data-group-ov-mobile") || "";
        const d = ovImg.getAttribute("data-group-ov-desktop") || "";
        if (b === "mobile") return m || "";
        return d || "";
      }

      function setOverlaySrcWithFallbacks(bucket, fetchedVariantOverlaySrc){
        if (!ovImg) return;

        const desired = preferredGroupOverlaySrc(bucket);
        const fallbacks = uniq([
          desired,
          String(fetchedVariantOverlaySrc || "").trim(),
          String(initialOverlaySrc || "").trim(),
        ]).filter(Boolean);

        if (!fallbacks.length) return;

        const nonce = ++_ovSwapNonce;
        let idx = 0;

        function trySet(){
          if (nonce !== _ovSwapNonce) return;
          const next = fallbacks[idx];
          if (!next) return;

          if (ovImg.getAttribute("src") === next) return;

          ovImg.onerror = () => {
            if (nonce !== _ovSwapNonce) return;
            idx++;
            if (idx < fallbacks.length) trySet();
          };

          ovImg.src = next;
        }

        trySet();
      }

      async function switchToBucket(bucket){
        const b = String(bucket || "").trim().toLowerCase();

        setOverlaySrcWithFallbacks(b, "");
        applyOverlayClamp(b);

        if (window.__RESPONSIVE__?.mergedGroup) {
          window.__CURRENT_PREVIEW_SLUG__ = groupKey;
          await reapplyPatchesIfAvailable();
          return;
        }

        if (b === "desktop") {
          if (contentEl) contentEl.innerHTML = initialContentHtml;

          setOverlaySrcWithFallbacks("desktop", "");

          if (ovImg) {
            if (initialOvW && isFinite(initialOvW)) ovImg.setAttribute("data-ov-w", String(initialOvW));
            else ovImg.removeAttribute("data-ov-w");
          }

          window.__CURRENT_PREVIEW_SLUG__ = initialSlug;

          if (initialOvW && isFinite(initialOvW)) window.__RESPONSIVE__.overlayW.desktop = initialOvW;

          applyOverlayClamp("desktop");
          await reapplyPatchesIfAvailable();
          return;
        }

        const candidates = deriveCandidateSlugs(b);

        for (const s of candidates) {
          try{
            const html = await fetchVariantHtml(s);
            const { contentHtml, overlaySrc, overlayW: ow, overlayH: oh } = extractFromHtml(html);

            if (contentEl && contentHtml) contentEl.innerHTML = contentHtml;

            if (ovImg) {
              setOverlaySrcWithFallbacks(b, overlaySrc);

              if (ow) {
                ovImg.setAttribute("data-ov-w", String(ow));
                window.__RESPONSIVE__.overlayW[b] = ow;
              } else {
                ovImg.removeAttribute("data-ov-w");
              }

              if (oh) ovImg.setAttribute("data-ov-h", String(oh));
              else ovImg.removeAttribute("data-ov-h");

              applyOverlayClamp(b);
            }

            window.__CURRENT_PREVIEW_SLUG__ = s;
            await reapplyPatchesIfAvailable();
            return;
          } catch {
            // try next
          }
        }

        await reapplyPatchesIfAvailable();
      }

      window.__onPreviewBucketChange = ({ bucket }) => { switchToBucket(bucket); };

      function bucketForWidth(w){
        const ww = Number(w) || 0;
        if (ww > 0 && ww <= 768) return "mobile";
        if (ww > 0 && ww <= 1084) return "tablet";
        return "desktop";
      }

      (function initOverlay(){
        const qs = new URLSearchParams(location.search);
        const qW = Number(qs.get("vpw"));
        const w = (isFinite(qW) && qW > 0) ? qW : (respWidths.desktop || 1728);
        const b = bucketForWidth(w);

        setOverlaySrcWithFallbacks(b, "");
        applyOverlayClamp(b);
      })();
    })();
  </script>

  <!-- Apply patches (shared implementation) -->
  
  <script>
    (function(){
      const fallback = "hero_v3";

      const getSlug = () =>
        String(window.__CURRENT_PREVIEW_SLUG__ || fallback || "").trim();

      function asObj(v){ return (v && typeof v === 'object') ? v : null; }

      function applyPatchToEl(el, patch){
        if (!el || !patch) return;

        if (Array.isArray(patch.classAdd)) {
          for (const c of patch.classAdd) {
            const cls = String(c || '').trim();
            if (cls) el.classList.add(cls);
          }
        }

        if (Array.isArray(patch.classRemove)) {
          for (const c of patch.classRemove) {
            const cls = String(c || '').trim();
            if (cls) el.classList.remove(cls);
          }
        }

        if (asObj(patch.classReplace)) {
          for (const from in patch.classReplace) {
            const to = String(patch.classReplace[from] || '').trim();
            const fr = String(from || '').trim();
            if (!fr || !to) continue;
            if (el.classList.contains(fr)) {
              el.classList.remove(fr);
              el.classList.add(to);
            }
          }
        }

        if (asObj(patch.style)) {
          for (const k in patch.style) {
            const v = patch.style[k];
            if (v === null || typeof v === 'undefined') continue;
            try { el.style[k] = String(v); } catch {}
          }
        }
      }

      async function loadPatches(slug){
        try{
          const url = "/fixtures.out/" + encodeURIComponent(slug) + "/patches.json";
          const r = await fetch(url, { cache: 'no-store' });
          if (!r.ok) return null;
          const json = await r.json();
          return asObj(json) || null;
        } catch {
          return null;
        }
      }

      function applyAll(patches){
        if (!patches) return;
        const nodes = Array.from(document.querySelectorAll('[data-node-id],[data-node]'));
        for (const el of nodes) {
          const id = el.getAttribute('data-node-id') || el.getAttribute('data-node') || null;
          if (!id) continue;
          const p = patches[id];
          if (p) applyPatchToEl(el, p);
        }
      }

      async function applyCurrent(){
        const slug = getSlug();
        if (!slug) return;
        const patches = await loadPatches(slug);
        if (!patches) return;
        applyAll(patches);
      }

      // expose for responsive swapper
      window.__applyPatchesForCurrentSlug__ = applyCurrent;

      applyCurrent();
    })();
  </script>
  

  <!-- Viewport sizing + bucket detection (reads window.__RESPONSIVE__) -->
  
  <script>
    (function(){
      // =========================================================
      // Viewport sizing (NO scaling) + responsive bucket switching
      //
      // Breakpoints (your spec):
      // - mobile:  <= 768
      // - tablet:  769..1084
      // - desktop: >= 1085
      //
      // IMPORTANT:
      // Tailwind breakpoints do NOT respond to changing a div width.
      // So we expose hooks to let preview swap markup + overlay by bucket.
      // =========================================================

      const FALLBACK_DESIGN_W = 1728;
      const slug = "hero_v3";

      // preview.html.js (or another injected script) can set:
      // window.__RESPONSIVE__ = {
      //   groupKey: "Home v3", // shared state across variants
      //   widths: { mobile: 390, tablet: 1084, desktop: 1728 },
      //   breakpoints: { mobileMax: 768, tabletMax: 1084 }
      // };
      const resp = (window.__RESPONSIVE__ && typeof window.__RESPONSIVE__ === "object")
        ? window.__RESPONSIVE__
        : null;

      const groupKey = (resp && typeof resp.groupKey === "string" && resp.groupKey.trim())
        ? resp.groupKey.trim()
        : slug;

      const key = "previewViewport:" + groupKey;

      const btnM = document.getElementById("vp_mobile");
      const btnT = document.getElementById("vp_tablet");
      const btnD = document.getElementById("vp_desktop");

      const frame = document.getElementById("device_frame");
      const rail = document.getElementById("vp_rail");
      const thumb = document.getElementById("vp_thumb");
      const readout = document.getElementById("vp_readout");

      const cmp = document.getElementById("cmp_root");

      if (!frame || !rail || !thumb || !readout || !btnM || !btnT || !btnD) return;

      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
      const minW = 320;

      // ----- Breakpoints (as per your spec) -----
      const bpMobileMax = Number(resp?.breakpoints?.mobileMax) || 768;
      const bpTabletMax = Number(resp?.breakpoints?.tabletMax) || 1084;

      // ----- Design widths (must match Figma frames) -----
      // These are preset button targets (NOT the breakpoint thresholds).
      const wMobile  = Number(resp?.widths?.mobile)  || 390;
      const wTablet  = Number(resp?.widths?.tablet)  || 1084;
      const wDesktop = Number(resp?.widths?.desktop) || FALLBACK_DESIGN_W;

      // Max resize width should be the desktop design width (not current bucket width)
      const maxW = Math.max(wDesktop, wTablet, wMobile, FALLBACK_DESIGN_W);

      // Expose design clamp for CSS (device frame max width)
      frame.style.setProperty("--design-w", String(maxW) + "px");

      const state = (() => {
        try { return JSON.parse(localStorage.getItem(key) || "{}") || {}; }
        catch { return {}; }
      })();

      function bucketForWidth(w){
        if (w <= bpMobileMax) return "mobile";
        if (w <= bpTabletMax) return "tablet";
        return "desktop";
      }

      function setActive(which){
        btnM.dataset.active = which === "mobile" ? "1" : "0";
        btnT.dataset.active = which === "tablet" ? "1" : "0";
        btnD.dataset.active = which === "desktop" ? "1" : "0";
      }

      function setThumb(w){
        const r = rail.getBoundingClientRect();
        const denom = (maxW - minW) || 1;
        const t = (w - minW) / denom;
        thumb.style.left = (t * r.width) + "px";
      }

      function setOverlayClampForBucket(b){
        if (!cmp) return;
        const ow = (b === "mobile") ? wMobile : (b === "tablet") ? wTablet : wDesktop;
        cmp.style.setProperty("--overlay-w", ow + "px");
        cmp.dataset.bucket = b;
      }

      let currentBucket = null;

      // Hook: preview HTML can implement to swap variant markup + overlay
      // window.__onPreviewBucketChange = ({ bucket, widthPx }) => {}
      function notifyBucketChange(nextBucket, w){
        if (typeof window.__onPreviewBucketChange === "function") {
          try { window.__onPreviewBucketChange({ bucket: nextBucket, widthPx: w }); } catch {}
        }
      }

      function setWidth(px, forcedLabel){
        const w = clamp(Math.round(px), minW, maxW);

        frame.style.setProperty("--vpw", w + "px");
        readout.textContent = w + "px";
        setThumb(w);

        const b = bucketForWidth(w);

        // Buttons reflect bucket even when dragging
        setActive(b);

        // Clamp overlay to the *variant* design width for the current bucket
        setOverlayClampForBucket(b);

        state.w = w;
        state.which = forcedLabel || b;
        localStorage.setItem(key, JSON.stringify(state));

        if (b !== currentBucket) {
          currentBucket = b;
          notifyBucketChange(b, w);
        }
      }

      const presets = { mobile: wMobile, tablet: wTablet, desktop: wDesktop };

      // Init width (URL param wins, then stored, then desktop)
      const qs = new URLSearchParams(location.search);
      const qW = Number(qs.get("vpw"));
      const initW =
        Number.isFinite(qW) && qW > 0
          ? qW
          : (Number(state.w) || wDesktop || maxW);

      setWidth(initW, null);

      // Preset buttons jump to *Figma design widths*
      btnM.addEventListener("click", () => setWidth(presets.mobile, "mobile"));
      btnT.addEventListener("click", () => setWidth(presets.tablet, "tablet"));
      btnD.addEventListener("click", () => setWidth(presets.desktop, "desktop"));

      // Drag rail
      let dragging = false;

      function clientX(e){
        if (e.touches && e.touches[0]) return e.touches[0].clientX;
        return e.clientX;
      }

      function onMove(e){
        if (!dragging) return;
        const r = rail.getBoundingClientRect();
        const x = clamp(clientX(e) - r.left, 0, r.width);
        const t = r.width ? (x / r.width) : 0;
        const w = minW + t * (maxW - minW);
        setWidth(w, null);
        e.preventDefault();
      }

      function onUp(){
        dragging = false;
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
        document.removeEventListener("touchmove", onMove);
        document.removeEventListener("touchend", onUp);
      }

      rail.addEventListener("mousedown", (e) => {
        dragging = true;
        onMove(e);
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });

      rail.addEventListener("touchstart", (e) => {
        dragging = true;
        onMove(e);
        document.addEventListener("touchmove", onMove, { passive: false });
        document.addEventListener("touchend", onUp);
      }, { passive: false });

      // Ensure no accidental scaling
      frame.style.transform = "none";
      frame.style.zoom = "1";
    })();
  </script>


  
  <div id="score_modal_backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="score_modal_title">
      <div class="modal-hd">
        <div>
          <div id="score_modal_title" class="modal-title">Visual diff scores</div>
          <div class="modal-sub">
            Slug: <span class="mono" id="score_slug_label">hero_v3</span>
          </div>
        </div>
        <button id="score_modal_close" class="btn2" aria-label="Close">Close</button>
      </div>

      <div class="modal-bd">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px;">
          <span id="score_pill" class="pill" data-kind="fail">No score loaded</span>
          <span id="score_main" class="mono" style="font-size:12px;color:rgba(15,23,42,.7)"></span>
        </div>

        <div class="grid">
          <div class="card">
            <div class="k">Diff ratio</div>
            <div id="score_diffRatio" class="v mono">—</div>
          </div>
          <div class="card">
            <div class="k">Diff pixels</div>
            <div id="score_diffPixels" class="v mono">—</div>
          </div>

          <div class="card">
            <div class="k">Threshold</div>
            <div id="score_threshold" class="v mono">—</div>
          </div>
          <div class="card">
            <div class="k">Pass diff ratio</div>
            <div id="score_passDiffRatio" class="v mono">—</div>
          </div>

          <div class="card">
            <div class="k">Viewport</div>
            <div id="score_viewport" class="v mono">—</div>
          </div>
          <div class="card">
            <div class="k">Timestamp</div>
            <div id="score_at" class="v mono">—</div>
          </div>
        </div>

        <div style="margin-top:14px;" class="links">
          <a id="score_link_score" href="#" target="_blank" rel="noreferrer">score.json</a>
          <a id="score_link_figma" href="#" target="_blank" rel="noreferrer">figma.png</a>
          <a id="score_link_render" href="#" target="_blank" rel="noreferrer">render.png</a>
          <a id="score_link_diff" href="#" target="_blank" rel="noreferrer">diff.png</a>
        </div>
      </div>

      <div class="modal-ft">
        <div style="font-size:12px;color:rgba(15,23,42,.7)">
          Tip: run compare after adjusting opacity/diff for a clean measurement.
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="score_run_compare" class="btn2 primary">Run compare</button>
          <button id="score_refresh" class="btn2">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const ovForcedOff = qs.get('ov') === '0';

      const getSlug = () => String(window.__CURRENT_PREVIEW_SLUG__ || "hero_v3" || "").trim();

      const cmp = document.getElementById('cmp_root');
      const img = document.getElementById('ov_img');
      const enabled = document.getElementById('ov_enabled');
      const opacity = document.getElementById('ov_opacity');
      const opacityVal = document.getElementById('ov_opacity_val');
      const diff = document.getElementById('ov_diff');
      const reset = document.getElementById('ov_reset');

      if (!cmp || !img) return;

      const groupKey = String(window.__RESPONSIVE__?.groupKey || "") || getSlug();
      const key = 'figmaOverlay:' + groupKey;

      const state = (() => {
        try { return JSON.parse(localStorage.getItem(key) || '{}') || {}; } catch { return {}; }
      })();

      const clamp01 = (x) => Math.max(0, Math.min(1, x));
      const clampInt = (x, a, b) => Math.max(a, Math.min(b, x));

      function save(){
        const next = {
          enabled: enabled ? !!enabled.checked : true,
          opacity: clampInt(Number(opacity?.value) || 0, 0, 100),
          diff: !!diff?.checked,
        };
        localStorage.setItem(key, JSON.stringify(next));
      }

      function apply(){
        const on = !ovForcedOff && (enabled ? enabled.checked : true);
        img.classList.toggle('overlay-hidden', !on);

        const op = ovForcedOff ? 0 : clamp01((Number(opacity?.value) || 0) / 100);
        const mode = (!ovForcedOff && on && diff?.checked) ? 'difference' : 'normal';

        cmp.style.setProperty('--oop', String(op));
        cmp.style.setProperty('--obm', mode);

        img.style.opacity = String(op);
        img.style.mixBlendMode = mode;

        void img.offsetHeight;

        if (opacityVal && opacity) opacityVal.textContent = String(opacity.value || '0') + '%';
      }

      if (enabled) enabled.checked = ovForcedOff ? false : (state.enabled !== false);
      if (opacity) opacity.value = String(clampInt(Number(state.opacity ?? 50), 0, 100));
      if (diff) diff.checked = !!state.diff;

      if (enabled) enabled.addEventListener('change', () => { save(); apply(); });
      if (opacity) opacity.addEventListener('input', () => { save(); apply(); });
      if (diff) diff.addEventListener('change', () => { save(); apply(); });

      if (reset) reset.addEventListener('click', () => {
        if (enabled) enabled.checked = true;
        if (opacity) opacity.value = '50';
        if (diff) diff.checked = false;
        save(); apply();
      });

      apply();

      // ---------------- Scores modal ----------------
      const scoreBtn = document.getElementById('ov_scores');
      const modalBackdrop = document.getElementById('score_modal_backdrop');
      const modalClose = document.getElementById('score_modal_close');
      const runCompareBtn = document.getElementById('score_run_compare');
      const refreshBtn = document.getElementById('score_refresh');
      const scoreSlugLabel = document.getElementById('score_slug_label');

      const scoreEls = {
        pill: document.getElementById('score_pill'),
        main: document.getElementById('score_main'),
        diffRatio: document.getElementById('score_diffRatio'),
        diffPixels: document.getElementById('score_diffPixels'),
        threshold: document.getElementById('score_threshold'),
        passDiffRatio: document.getElementById('score_passDiffRatio'),
        viewport: document.getElementById('score_viewport'),
        at: document.getElementById('score_at'),
        linkScore: document.getElementById('score_link_score'),
        linkFigma: document.getElementById('score_link_figma'),
        linkRender: document.getElementById('score_link_render'),
        linkDiff: document.getElementById('score_link_diff'),
      };

      function pct(x){
        const n = Number(x);
        if (!isFinite(n)) return '—';
        return (n * 100).toFixed(2) + '%';
      }

      function setModalOpen(isOpen){
        if (!modalBackdrop) return;
        modalBackdrop.dataset.open = isOpen ? "1" : "0";
        modalBackdrop.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
      }

      function fmtDate(iso){
        try{
          const d = new Date(String(iso||''));
          if (!isFinite(d.getTime())) return '—';
          return d.toLocaleString();
        } catch { return '—'; }
      }

      function applyScore(score){
        if (!scoreEls.pill) return;

        if (!score){
          scoreEls.pill.dataset.kind = "fail";
          scoreEls.pill.textContent = "No score found";
          scoreEls.main.textContent = "";
          scoreEls.diffRatio.textContent = "—";
          scoreEls.diffPixels.textContent = "—";
          scoreEls.threshold.textContent = "—";
          scoreEls.passDiffRatio.textContent = "—";
          scoreEls.viewport.textContent = "—";
          scoreEls.at.textContent = "—";
          return;
        }

        const pass = !!score.pass;

        scoreEls.pill.dataset.kind = pass ? "pass" : "fail";
        scoreEls.pill.textContent = pass ? "PASS" : "FAIL";

        scoreEls.main.textContent =
          `diffRatio ${pct(score.diffRatio)} · pass<=${pct(score.compare?.passDiffRatio)}`;

        scoreEls.diffRatio.textContent = pct(score.diffRatio);
        scoreEls.diffPixels.textContent = String(score.diffPixels ?? '—');
        scoreEls.threshold.textContent = String(score.compare?.threshold ?? '—');
        scoreEls.passDiffRatio.textContent = pct(score.compare?.passDiffRatio);
        scoreEls.viewport.textContent =
          score.viewport?.width && score.viewport?.height
            ? `${score.viewport.width}×${score.viewport.height}`
            : '—';
        scoreEls.at.textContent = fmtDate(score.at);

        const currentSlug = getSlug();
        const base = `/fixtures.out/${encodeURIComponent(currentSlug)}`;
        if (scoreEls.linkScore) scoreEls.linkScore.href = `${base}/score.json`;

        const merged = !!window.__RESPONSIVE__?.mergedGroup;
        if (scoreEls.linkFigma) scoreEls.linkFigma.href = merged ? `${base}/figma.desktop.png` : `${base}/figma.png`;

        if (scoreEls.linkRender) scoreEls.linkRender.href = `${base}/render.png`;
        if (scoreEls.linkDiff) scoreEls.linkDiff.href = `${base}/diff.png`;
      }

      async function loadLatestScore(){
        try{
          const currentSlug = getSlug();
          const r = await fetch(`/fixtures.out/${encodeURIComponent(currentSlug)}/score.json`, { cache: 'no-store' });
          if (!r.ok) return null;
          return await r.json();
        } catch {
          return null;
        }
      }

      async function runCompare(){
        const currentSlug = getSlug();
        const body = { waitMs: 350, screenshot: { mode: "element", selector: "#cmp_root", minHeight: 50 } };

        const r = await fetch(`/api/compare/${encodeURIComponent(currentSlug)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        const out = await r.json().catch(() => null);
        if (!r.ok || !out?.ok) {
          const msg = out?.error ? String(out.error) : `Compare failed (${r.status})`;
          throw new Error(msg);
        }
        return out.score;
      }

      async function openScores(){
        setModalOpen(true);
        if (scoreEls.pill) scoreEls.pill.textContent = "Loading…";
        if (scoreSlugLabel) scoreSlugLabel.textContent = getSlug();
        const score = await loadLatestScore();
        applyScore(score);
      }

      if (scoreBtn) scoreBtn.addEventListener('click', () => { openScores(); });

      if (modalClose) modalClose.addEventListener('click', () => setModalOpen(false));
      if (modalBackdrop) {
        modalBackdrop.addEventListener('click', (e) => {
          if (e.target === modalBackdrop) setModalOpen(false);
        });
      }

      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') setModalOpen(false); });

      if (refreshBtn) refreshBtn.addEventListener('click', async () => {
        if (scoreEls.pill) scoreEls.pill.textContent = "Loading…";
        if (scoreSlugLabel) scoreSlugLabel.textContent = getSlug();
        const score = await loadLatestScore();
        applyScore(score);
      });

      if (runCompareBtn) runCompareBtn.addEventListener('click', async () => {
        try{
          runCompareBtn.disabled = true;
          runCompareBtn.textContent = "Running…";
          const score = await runCompare();
          applyScore(score);
        } catch (e){
          if (scoreEls.pill) {
            scoreEls.pill.dataset.kind = "fail";
            scoreEls.pill.textContent = "Compare error";
          }
          if (scoreEls.main) scoreEls.main.textContent = (e && e.message) ? e.message : String(e);
        } finally {
          runCompareBtn.disabled = false;
          runCompareBtn.textContent = "Run compare";
        }
      });
    })();
  </script>
  

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const embed = qs.get('embed') === '1';
      if (embed || qs.get('toolbar') === '0') {
        const tb = document.getElementById('toolbar_root');
        if (tb) tb.style.display = 'none';
      }
    })();
  </script>
</body>
</html>